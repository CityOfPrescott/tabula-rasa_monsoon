<?php/** * Template Name: GIS - Parcel History * */get_header(); ?>	<div id="primary" class="content-area">		<main id="main" class="site-main" role="main">	<div class="hfeed content old_portal">		<?php if (have_posts()) : while (have_posts()) : the_post(); ?>		<div <?php post_class() ?> id="post-<?php the_ID(); ?>">			<img src="/_i/icons/<?php echo get_post_meta($post->ID, 'title_icon', true); ?>" class="h2title" />			<h2><?php the_title(); ?></h2>			<hr />			<div class="entry">				<?php the_content('<p class="serif">Read the rest of this page &raquo;</p>'); ?>				<?php wp_link_pages(array('before' => '<p><strong>Pages:</strong> ', 'after' => '</p>', 'next_or_number' => 'number')); ?>			</div><?php// Connect to the databaseif ( $_SERVER['REMOTE_ADDR'] == '127.0.0.1' ) {
	require_once ('db_info.php');
} else {
	require_once ('/usr/local/www/apache22/data/db_info.php');
}$dbc = db_connect ($db_info['gis']);?><div id="search_properties"<!-- Search by Parcel -->	<form action="" method="post" name="parcel">		<p>			<strong>Search by Parcel Number</strong><br />			<!--<input type="hidden" name="page_id" id="page_id" value="8465" /> -->			<input type="text" size="3" maxlength="3" name="parcel_num_1" onKeyup="autotab(this, document.parcel.parcel_num_2)" />-			<input type="text" size="2" maxlength="2" name="parcel_num_2" onKeyup="autotab(this, document.parcel.parcel_num_3)" />-			<input type="text" size="4" maxlength="4" name="parcel_num_3" />		</p>		<p>			<strong>Do you want to search Forward or Backward from this parcel?</strong><br />			<input type="radio" name="fromto" value="back" /> <strong>Backward-</strong> This is a current parcel number and want to know what it was before <br /> 			<input type="radio" name="fromto" value="forward"  checked="checked"/> <strong>Forward-</strong> This is an old parcel number that has now become something else <br /> 		</p>		<input type="hidden" value="TRUE" name="parcel_submitted" />		<input type="submit" value="Search" name="parcel_submit" />	</form>	<?php $selected_radio = $_POST['fromto']; ?></div><?phpif ($_GET['parcel_num']){ 	$search_by = $_GET['parcel_num'];	$selected_radio = $_GET['backfore'];} elseif ( isset( $_POST['parcel_submitted'] ) ) {	$search_by = $_POST['parcel_num_1']. '-' .$_POST['parcel_num_2']. '-' .$_POST['parcel_num_3'];} if ($selected_radio == 'back'){	$sql = ' WHERE ToParcel = "'.$search_by.'" ORDER BY ToParcel ASC';} else {	$sql = ' WHERE FromParcel = "'.$search_by.'" ORDER BY FromParcel ASC';}	if (isset($_POST['parcel_submitted']) or $_GET['parcel_num']) {	 // Query the db	$query = "SELECT *, DATE_FORMAT(TransactionDateTime, '%Y, %m-%d') as date FROM parsplit".$sql."";	$result = @mysql_query ($query);	$num = mysql_num_rows ($result);  	//THIS GETS USED FOR DEBUGGING THE QUERY		// If it ran okay, display the records	if ($result) {		// If there were no records found		if (!$num) {			echo '<p class="results">We\'re sorry, your search for <strong>' .$search_by. '</strong> returned no results. Please try again.</p>';		} else { //display the number of results by generation			if ($selected_radio == 'back') {				echo '<p class="results">Your search for <strong>' .$search_by. '</strong> Backwards returned <strong>' .$num. '</strong> Parents, beneath each parent its Grandparents, and Great-Grandparents are also displayed. <strong></p>';			} else { 				echo '<p class="results">Your search for <strong>' .$search_by. '</strong> Forwards returned <strong>' .$num. '</strong> Children, beneath each Child its Grandchildren and Great-Grandchildren are also displayed.</p>';			}?>			<p>You are seeing three generations of results the third generation parcels are displayed as links to make searching deeper a quick task- Clicking a linked parcel will re-run the search with that parcel number.</p>						<table id="property_results">				<thead>					<tr>						<th width="220">FromParcel</th>						<th width="220" class="tcenter">ToParcel</th>						<th width="100" class="tcenter">Split or Combine</th>						<th width="220" class="tcenter">Transaction Date</th>					</tr>				</thead>			<tbody><?php		// First query- Loop through the records	//set the styles for the type of query- forward or back if ($selected_radio == 'back'){	$backfore = 'back';	$qry_style1 = "query1_back";	$qry_style2 = "query2_back";	$qry_style3 = "query3_back";} else {	$backfore = 'forward';	$qry_style1 = "query1";	$qry_style2 = "query2";	$qry_style3 = "query3";}				while ($row = mysql_fetch_array ($result, MYSQL_ASSOC)) { 	echo '	<tr class="' .$qry_style1. '">		<td class="' .$qry_style1. '">' .$row['FromParcel']. '</td>		<td class="' .$qry_style1. '">' .$row['ToParcel']. '</td>		<td class="tcenter">' .$row['TransactionType']. '</td>		<td class="tcenter">' .$row['date']. '</td>	</tr>';	// Begin second Query- Loop through again using the ToParcel Values returned from the first set	if ($selected_radio == 'back'){		$sql2 = ' WHERE ToParcel = "'.$row['FromParcel']. '" ORDER BY FromParcel ASC';	} else {		$sql2 = ' WHERE FromParcel = "'.$row['ToParcel']. '" ORDER BY FromParcel ASC';	}		$query2 = "SELECT *, DATE_FORMAT(TransactionDateTime, '%Y, %m-%d') as date FROM parsplit".$sql2."";	$result2 = @mysql_query ($query2);	$num2 = mysql_num_rows($result2);	//THIS GETS USED FOR DEBUGGING THE SECOND QUERY	if ($num2> 0) { 		while ($row2 = mysql_fetch_array ($result2, MYSQL_ASSOC)){			echo '			<tr class="' .$qry_style2. '" >				<td class="'. $qry_style2. '">' .$row2['FromParcel']. '</td>				<td class="'. $qry_style2. '">' .$row2['ToParcel']. '</td>				<td class="tcenter">' .$row2['TransactionType']. '</td>				<td class="tcenter">' .$row2['date']. '</td>			</tr>';			//This is the third  Loop through again using the ToParcel Values returned from the first set			if ($selected_radio == 'back'){				$sql3 = ' WHERE ToParcel = "'.$row2['FromParcel']. '" ORDER BY FromParcel ASC';			} else {				$sql3 = ' WHERE FromParcel = "'.$row2['ToParcel']. '" ORDER BY FromParcel ASC';			}								$query3 = "SELECT *, DATE_FORMAT(TransactionDateTime, '%Y, %m-%d') as date FROM parsplit".$sql3."";			$result3 = @mysql_query ($query3);			$num3 = mysql_num_rows($result3);			//THIS GETS USED FOR DEBUGGING THE THIRD QUERY			if ($num3> 0) {				while ($row3 = mysql_fetch_array ($result3, MYSQL_ASSOC)){					echo '<tr class="' .$qry_style3. '">';					if ($selected_radio == 'back') {						echo '						<td class="' .$qry_style3. '">							<a href="http://monsoon.ad.cityofprescott.org/?page_id=8465&parcel_num=' .$row3['FromParcel']. '&backfore=' .$backfore. '">' .$row3['FromParcel']. '</a>						</td>						<td class="' .$qry_style3. '">' .$row3['ToParcel']. '</td>';					} else { 						echo'						<td class="' .$qry_style3. '">' .$row3['FromParcel']. '</td>						<td class="' .$qry_style3. '">							<a href="http://monsoon.ad.cityofprescott.org/?page_id=8465&parcel_num=' .$row3['ToParcel']. '&backfore=' .$backfore. '">' .$row3['ToParcel']. '</a>						</td>';					}					echo '					<td class="tcenter">' .$row3['TransactionType']. '</td>					<td class="tcenter">' .$row3['date']. '</td>					</tr>';				}  //end of the third query loop				}  //end of the test if rows returned in third query		}  //end of the second query loop		}   //end of the test if rows returned in secondquery					// Add 1 to every row				$row_count++;} // End while loop} // End else		echo '</tbody></table>';							mysql_free_result($result); // Free up the resources	} else {		// If it did not run okay		echo '<p class="error">The records could not be displayed due to a system error. We apologize for any inconvenience.</p><p>'.mysql_error().'</p>';	}} else { // End if isset	echo '<p class="tcenter">Please search for property information using the form above.</p>';}mysql_close(); // Close the db connection?>		</div>		<?php endwhile; endif; ?>	<?php edit_post_link('Edit this entry.', '<p>', '</p>'); ?>	</div>		</main><!-- #main -->	</div><!-- #primary --><?php get_sidebar(); ?><?php get_footer(); ?>